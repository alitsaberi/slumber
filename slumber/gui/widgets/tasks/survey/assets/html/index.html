<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Survey Interface</title>

    <!-- External Dependencies -->
    <link href="../css/defaultV2.min.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../js/survey.core.min.js"></script>
    <script type="text/javascript" src="../js/survey-js-ui.min.js"></script>
    <script type="text/javascript" src="qrc:///qtwebchannel/qwebchannel.js"></script>
  </head>

  <body>
    <div id="loadingIndicator" class="loading-state">Loading survey...</div>
    <div id="errorContainer" class="error-message" style="display: none"></div>
    <div id="surveyContainer" role="main" aria-label="Survey Form"></div>

    <script type="text/javascript">
      function displayError(message) {
        const errorContainer = document.getElementById("errorContainer");
        errorContainer.textContent = message;
        errorContainer.style.display = "block";
        document.getElementById("loadingIndicator").style.display = "none";
      }

      class ChannelManager {
        static init(channel) {
          window.channelObject = channel.objects.channelObject;
          window.channelObject.ready = true;
          window.channelObject.onError = this.handleError;

          // Override console.log to forward messages to the Python logger
          console.log = function(message) {
            if (window.channelObject) {
              window.channelObject.handle_log(message); // Send log to Python
            }
          };
        }

        static handleError(error) {
          displayError(error);
          window.channelObject.handle_error(error);
        }
      }

      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      function initializeSurvey(surveyJson) {
        const survey = new Survey.Model(surveyJson);
        survey.onComplete.add(function (sender) {
          if (window.channelObject) {
            window.channelObject.handle_survey_submission(JSON.stringify(sender.data));
          }
        });
        return survey;
      }

      document.addEventListener("DOMContentLoaded", function () {
        if (typeof Survey === "undefined") {
          ChannelManager.handleError("SurveyJS library not found.");
          return;
        }

        const surveyPath = getQueryParam("survey_path");
        if (!surveyPath) {
          ChannelManager.handleError("No survey path provided.");
          return;
        }

        fetch(surveyPath)
          .then((response) => {
            document.getElementById("loadingIndicator").style.display = "none";
            if (!response.ok) {
              ChannelManager.handleError("Failed to load survey JSON.");
              return;
            }
            return response.json();
          })
          .then((surveyJson) => {
            const survey = initializeSurvey(surveyJson);
            survey.render(document.getElementById("surveyContainer"));
          })
          .catch((error) => {
            ChannelManager.handleError("Failed to fetch survey JSON.");
          });
      });

      new QWebChannel(qt.webChannelTransport, function (channel) {
        ChannelManager.init(channel);
      });
    </script>
  </body>
</html>
