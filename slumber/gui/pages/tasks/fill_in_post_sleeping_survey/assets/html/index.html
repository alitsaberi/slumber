<!DOCTYPE html>
<html lang="en">
  <!--
    Survey Interface
    
    This HTML file serves as the container for SurveyJS implementation.
    It loads necessary dependencies and handles communication between
    the survey interface and the Python backend through QWebChannel.
-->
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Survey Interface</title>

    <!-- External Dependencies -->
    <link href="../css/defaultV2.min.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../js/survey.core.min.js"></script>
    <script type="text/javascript" src="../js/survey-js-ui.min.js"></script>
    <script
      type="text/javascript"
      src="qrc:///qtwebchannel/qwebchannel.js"
    ></script>
  </head>

  <body>
    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-state">Loading survey...</div>

    <!-- Error Message Container -->
    <div id="errorContainer" class="error-message" style="display: none"></div>

    <!-- Survey Container -->
    <div id="surveyContainer" role="main" aria-label="Survey Form"></div>

    <script type="text/javascript">
      /**
       * Displays an error message in the error container and hides the loading indicator.
       * @param {string} message - The error message to display.
       */
      function displayError(message) {
        const errorContainer = document.getElementById("errorContainer");
        errorContainer.textContent = message;
        errorContainer.style.display = "block";
        document.getElementById("loadingIndicator").style.display = "none";
      }

      /**
       * Manages the QWebChannel and error handling for channelObject.
       */
      class ChannelManager {
        static init(channel) {
          window.channelObject = channel.objects.channelObject;
          window.channelObject.ready = true;
          window.channelObject.onError = this.handleError;
        }

        static handleError(error) {
          displayError(error);
          window.channelObject.logError(error);
        }
      }

      /**
       * Retrieves query parameter value from URL
       * @param {string} param - Parameter name to retrieve
       * @returns {string|null} Parameter value or null if not found
       */
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      /**
       * Initializes the survey and sets up the onComplete handler.
       * @param {object} surveyJson - The survey JSON configuration.
       * @returns {object} survey - The initialized SurveyJS Model instance.
       */
      function initializeSurvey(surveyJson) {
        const survey = new Survey.Model(surveyJson);

        // Send completed survey data to Python backend via QWebChannel and save it
        survey.onComplete.add(function (sender) {
          if (window.channelObject) {
            window.channelObject.saveSurveyData(JSON.stringify(sender.data));
          }
        });

        return survey;
      }

      // Main execution: Load and render survey JSON if available
      document.addEventListener("DOMContentLoaded", function () {
        if (typeof Survey === "undefined") {
          ChannelManager.handleError("SurveyJS library not found.");
          return;
        }

        // Retrieve the survey path from the URL
        const surveyPath = getQueryParam("survey_path");
        if (!surveyPath) {
          ChannelManager.handleError("No survey path provided.");
          return;
        }

        // Fetch the survey JSON from the provided path
        fetch(surveyPath)
          .then((response) => {
            document.getElementById("loadingIndicator").style.display = "none";
            if (!response.ok) {
              ChannelManager.handleError("Failed to load survey JSON.");
              return;
            }
            return response.json();
          })
          .then((surveyJson) => {
            const survey = initializeSurvey(surveyJson);
            survey.render(document.getElementById("surveyContainer")); // Render survey in container
          })
          .catch((error) => {
            ChannelManager.handleError("Failed to fetch survey JSON.");
          });
      });

      // Update QWebChannel initialization
      new QWebChannel(qt.webChannelTransport, function (channel) {
        ChannelManager.init(channel);
      });
    </script>
  </body>
</html>
